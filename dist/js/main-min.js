function drawTimeSeries(t,e,a){let s=10,i=50,n=25,d=50,o=250-s-n,r=document.getElementById("time-series").offsetWidth-d-i,c=d3.select("#time-series").select("svg").attr("width",r+d+i).attr("height",o+s+n).style("display","block").select("g").attr("transform","translate("+d+","+s+")"),l=d3.scaleTime().range([0,r]),u=d3.scaleLinear().range([o,0]);l.domain(e),u.domain(a);let m=d3.line().x(function(t){return l(t.date)}).y(function(t){return u(t.y)});c.select(".line").data([t]).attr("d",m);let h=d3.axisBottom(l).tickFormat(d3.timeFormat("%m/%Y")).ticks(d3.timeMonth.every(6)),f=d3.axisLeft(u);c.select(".xAxis").attr("transform","translate(0,"+o+")").call(h),c.select(".yAxis").call(f),c.select(".yAxisLabel").attr("transform","rotate(-90)").attr("y",0-d).attr("x",0-o/2).attr("dy","1em");let p=d3.bisector(function(t){return t.date}).left,v=d3.select("circle"),g=d3.select(".tooltip"),y=d3.timeFormat("%B %Y");c.select("rect").attr("width",r).attr("height",o).on("mouseover",function(){v.attr("visibility","visible"),g.attr("visibility","visible")}).on("mouseout",function(){v.attr("visibility","hidden"),g.attr("visibility","hidden")}).on("mousemove",function(){let e=l.invert(d3.mouse(this)[0]),a=p(t,e,1),s=t[a-1],i=t[a],n=e-s.date>i.date-e?i:s;v.attr("cx",l(n.date)).attr("cy",u(n.y)),g.attr("x",l(n.date)+160>r?l(n.date)-170:l(n.date)+10).attr("y",u(n.y)-25).select(".box").html(`\n          <p class = "heading">${y(n.date)}</p>\n          <p>New Agencies: ${n.y}</p>\n        `)})}function getSummaryStatistics(t,e,a){$("#last-updated").text(Math.round((new Date-new Date(t.snapshot.date))/36e5)),$("#statistic-lea").text(d3.format(",")(t.snapshot.agencies)),$("#statistic-video-requests").text(d3.format(",")(t.snapshot.videoRequests)),$("#statistic-states").text(Object.keys(e).length),$("#statistic-this-month").text(a)}function getUpdates(t){let e=d3.timeFormat("%m/%d/%Y");d3.select("#updates").selectAll("li").data(t).enter().append("li").html(function(t){return`\n          ${t.text}\n          <p class = "heading">${e(t.date)}</p>\n        `})}function drawMap(t,e,a,s){let i=d3.scaleLinear().domain([0,s?e:a]).range(["#dedede","#1f3a93"]);d3.select("#map").select("svg").selectAll(".path").data(t).style("fill",t=>i(s?t.agencies:t.videoRequests)).on("mouseover",function(t){console.log(t)}),console.log(t,e,a)}$.getJSON("http://127.0.0.1:3000/",function(t){let e={},a={},s=[];t.agencies.forEach(function(t){t.activeDate=new Date(t.activeDate);let i=new Date(t.activeDate.getFullYear(),t.activeDate.getMonth());i in e||(e[i]=0),e[i]+=1;let n=t.address.split(", ")[1];n in a||(a[n]={agencies:0,videoRequests:0}),a[n].agencies+=1,a[n].videoRequests+=t.videoRequests,t.activeDate.getFullYear()>=2020&&null==t.deactivateDate&&s.push({date:t.activeDate,text:`${t.name} (${n}) added a contract with Ring`})}),t.snapshot.obsolete.forEach(function(e){s.push({date:new Date(t.snapshot.date),text:`${e.name} (${e.address.split(", ")[1]}) removed their contract with Ring`})}),t.snapshot.update.forEach(function(e){e.videoRequests>e.prevVideoRequests&&s.push({date:new Date(t.snapshot.date),text:`${e.name} (${e.address.split(", ")[1]}) requested ${e.videoRequests-e.prevVideoRequests} video${e.videoRequests-e.prevVideoRequests==1?"":"s"}`})}),s=s.sort(function(t,e){return e.date-t.date}).slice(0,4);let i=new Date,n=new Date(i.getFullYear(),i.getMonth()),d=n in e?e[n]:0;e=Object.keys(e).map(function(t){return{date:new Date(t),y:e[t]}}).sort(function(t,e){return t.date-e.date});let o,r=d3.extent(e,function(t){return t.date}),c=[0,d3.max(e,function(t){return t.y})+20],l=0,u=0,m=["AK","HI","AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY","DC"].map(function(t){let e=t in a?a[t].agencies:0,s=t in a?a[t].videoRequests:0;return l=Math.max(l,e),u=Math.max(u,s),{state:t,agencies:e,videoRequests:s}});drawTimeSeries(e,r,c),getSummaryStatistics(t,a,d),getUpdates(s),drawMap(m,l,u,!0),$(window).resize(function(){clearTimeout(o),o=setTimeout(function(){drawTimeSeries(e,r,c)},100)})});